<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Winter AR â€” Snowmen & Pine Trees</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
      body { margin:0; }
      #ar-button { position:absolute; top:12px; right:12px; z-index:10; padding:8px 12px; background: rgba(255,255,255,0.95); border-radius:8px; cursor:pointer;}
      .hint { position:absolute; bottom:12px; left:12px; background:rgba(0,0,0,0.6); color:white; padding:8px 12px; border-radius:8px; z-index:10;}
    </style>
  </head>
  <body>
    <button id="ar-button">AR</button>
    <div class="hint">Tap the screen to place objects. Chrome on Android required.</div>

    <a-scene embedded webxr="optionalFeatures: hit-test;">
      <a-entity camera look-controls></a-entity>

      <!-- Snowman prototype -->
      <a-entity id="prototype-snowman" visible="false">
        <a-sphere radius="0.24" position="0 0.24 0" color="#fff"></a-sphere>
        <a-sphere radius="0.18" position="0 0.60 0" color="#fff"></a-sphere>
        <a-sphere radius="0.12" position="0 0.90 0" color="#fff"></a-sphere>
      </a-entity>

      <!-- Pine tree prototype -->
      <a-entity id="prototype-pinetree" visible="false">
        <a-cylinder radius="0.03" height="0.18" position="0 0.09 0" color="#5b3a21"></a-cylinder>
        <a-cone radius-bottom="0.25" radius-top="0.01" height="0.28" position="0 0.30 0" color="#0b8a2e"></a-cone>
        <a-cone radius-bottom="0.19" radius-top="0.01" height="0.24" position="0 0.45 0" color="#0fa43a"></a-cone>
      </a-entity>

      <!-- Reticle -->
      <a-entity id="reticle" geometry="primitive:ring; radiusInner:0.03; radiusOuter:0.05" rotation="-90 0 0" visible="false" material="color:green; shader:flat"></a-entity>
      <a-entity id="placements"></a-entity>
    </a-scene>

    <!-- Modified ar-hit-test component -->
    <script>
      AFRAME.registerComponent('ar-hit-test', {
        init: function () {
          const scene = this.el.sceneEl;
          const reticle = document.getElementById('reticle');

          // Container for spawned objects
          let container = document.getElementById('placements');
          if (!container) {
            container = document.createElement('a-entity');
            container.id = 'placements';
            scene.appendChild(container);
          }

          // Function to spawn snowman or pine tree at position
          function spawnAt(position) {
            const choice = Math.random() < 0.5 ? 'prototype-snowman' : 'prototype-pinetree';
            const proto = document.getElementById(choice).cloneNode(true);
            proto.setAttribute('visible','true');

            const wrapper = document.createElement('a-entity');
            wrapper.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
            wrapper.appendChild(proto);

            container.appendChild(wrapper);
          }

          // Tap listener
          scene.canvas.addEventListener('touchstart', () => {
            if (reticle && reticle.object3D.visible) {
              const pos = reticle.object3D.position.clone();
              spawnAt(pos);
            }
          });
        }
      });

      // Attach the component to the scene
      document.querySelector('a-scene').setAttribute('ar-hit-test','');

      // AR button functionality
      document.getElementById('ar-button').onclick = async () => {
        if (!navigator.xr) { alert('WebXR not supported'); return; }
        try {
          const supported = await navigator.xr.isSessionSupported('immersive-ar');
          if (!supported) { alert('Immersive AR not supported'); return; }
          const session = await navigator.xr.requestSession('immersive-ar',{requiredFeatures:['hit-test','local-floor']});
          await document.querySelector('a-scene').renderer.xr.setSession(session);
        } catch(err) { alert('AR session failed: '+err); console.error(err); }
      };
    </script>
  </body>
</html>
